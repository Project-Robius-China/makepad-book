# 2 - åˆ›å»ºä¸€ä¸ªç©ºçª—å£

åœ¨ä¸Šä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ç©ºçš„ Cargo åŒ…ã€‚åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬å°†æŠŠè¿™ä¸ªç©ºåŒ…å˜æˆä¸€ä¸ªæœ€å°çš„ Makepad åº”ç”¨ï¼Œä»…åŒ…å«ä¸€ä¸ªç©ºçª—å£ã€‚

## ä½ å°†å­¦åˆ°

åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œä½ å°†å­¦ä¹ ï¼š

- å¦‚ä½•æ·»åŠ  Makepad ä½œä¸ºä¾èµ–é¡¹ã€‚
- å¦‚ä½•ä½¿ç”¨ DSL ä»£ç å®šä¹‰åº”ç”¨çš„å¸ƒå±€å’Œæ ·å¼ã€‚
- å¦‚ä½•åˆ›å»ºä¸€ä¸ªç©ºçª—å£ã€‚

> ğŸ’¡ å¦‚æœä½ ä¸æƒ³è·Ÿç€æ‰‹åŠ¨è¾“å…¥ï¼Œå¯ä»¥ç›´æ¥æŸ¥çœ‹è¿™ä¸€æ­¥çš„å®Œæ•´ä»£ç ï¼š[GitHub é“¾æ¥](https://github.com/makepad/image_viewer/tree/main/step_2)

---

## æ·»åŠ  Makepad ä½œä¸ºä¾èµ–

æˆ‘ä»¬ä»å‘é¡¹ç›®æ·»åŠ  Makepad ä¾èµ–å¼€å§‹ã€‚

Makepad çš„é¡¶å±‚ crate æ˜¯ `makepad-widgets`ï¼Œå®ƒåŒ…å«äº†æ„å»ºåº”ç”¨æ‰€éœ€çš„ä¸€åˆ‡ã€‚

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ·»åŠ ä¾èµ–ï¼š

```bash
cargo add makepad-widgets
```

## æ·»åŠ ä»£ç 

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ·»åŠ æ‰€éœ€çš„ä»£ç ã€‚

å°†ä»¥ä¸‹æ–‡ä»¶å¤åˆ¶åˆ°`src`ç›®å½•ä¸­ï¼ˆæˆ‘ä»¬éšåä¼šè§£é‡Šä»£ç çš„ä½œç”¨ï¼‰ï¼š

`app.rs:`

```rust
use makepad_widgets::*;

live_design! {
    use link::widgets::*;

    App = {{App}} {
        ui: <Root> {
            <Window> {
                body = <View> {}
            }
        }
    }
}

#[derive(Live, LiveHook)]
pub struct App {
    #[live]
    ui: WidgetRef,
}

impl AppMain for App {
    fn handle_event(&mut self, cx: &mut Cx, event: &Event) {
        self.ui.handle_event(cx, event, &mut Scope::empty());
    }
}

impl LiveRegister for App {
    fn live_register(cx: &mut Cx) {
        makepad_widgets::live_design(cx);
    }
}

app_main!(App);
```

`lib.rs:`

```rust
pub mod app;
```

`main.rs:`

```rust
fn main() {
    image_viewer::app::app_main()
}
```

## æ£€æŸ¥å½“å‰è¿›å±•

ç¡®ä¿ä½ åœ¨é¡¹ç›®ç›®å½•ä¸‹ï¼Œè¿è¡Œï¼š

```bash
cargo run --release
```

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ªç©ºçª—å£ï¼š

![](https://publish-01.obsidian.md/access/2761c71cc8fcd60e8a34be708fcd655f/Tutorials/Image%20Viewer/Empty%20Window.png)

## ä»£ç è§£æ

### Live Design å—

ä»¥ä¸‹ä»£ç å®šä¹‰äº†ä¸€ä¸ª**live design**å—ï¼š

```rust
live_design! {
    use link::widgets::*;

    App = {{App}} {
        ui: <Root> {
            <Window> {
                body = <View> {}
            }
        }
    }
}
```

Live Design å—ç”¨äºå®šä¹‰ Makepad çš„**DSL ä»£ç **ã€‚DSL åœ¨ Makepad ä¸­ç”¨äºæè¿°å¸ƒå±€å’Œæ ·å¼ï¼Œç±»ä¼¼ CSSã€‚

è®©æˆ‘ä»¬é€è¡Œæ‹†è§£ï¼š

- `use link::widgets::*';` å¯¼å…¥å†…ç½®ç»„ä»¶ï¼Œæ¯”å¦‚ `Root`,`Window` å’Œ `View`ã€‚

- `App = {{App}} { ... }` å®šä¹‰äº†ä¸€ä¸ª `App`ã€‚

- `{{App}}` è¯­æ³•è¡¨ç¤ºè¯¥ DSL å®šä¹‰ä¸ Rust ä¸­çš„ `App` ç»“æ„ä½“ç›¸å…³è”ã€‚

- åœ¨ App ä¸­ï¼Œæˆ‘ä»¬å°† `ui` å­—æ®µå®šä¹‰ä¸ºç»„ä»¶æ ‘çš„æ ¹èŠ‚ç‚¹ï¼š

    - `<Root> { ... }` æ˜¯æˆ‘ä»¬çš„é¡¶å±‚å®¹å™¨ã€‚

    - `<Window> { ... }` æ˜¯å±å¹•ä¸Šçš„ä¸€ä¸ªçª—å£ã€‚
  
    - `body = <View> {}` æ˜¯ä¸€ä¸ªå‘½åä¸º `body` çš„ç©ºè§†å›¾ã€‚

#### Live è®¾è®¡ç³»ç»Ÿ

å½“æˆ‘ä»¬è¿è¡Œåº”ç”¨ç¨‹åºæ—¶ï¼ŒMakepad ä½¿ç”¨ä¸€ç§å«åš Live è®¾è®¡ç³»ç»Ÿ çš„æœºåˆ¶ï¼Œå°† DSL ä»£ç ä¸ Rust ä»£ç è¿›è¡Œæ¡¥æ¥ã€‚

å…¶æ ¸å¿ƒæ€æƒ³å¦‚ä¸‹ï¼š

- åº”ç”¨çš„å¸ƒå±€å’Œæ ·å¼æ˜¯é€šè¿‡ DSL ä»£ç å®šä¹‰çš„ã€‚

- Live è®¾è®¡ç³»ç»Ÿä¼šå°† DSL ä¸­çš„å®šä¹‰åŒ¹é…åˆ°å¯¹åº”çš„ Rust ç»“æ„ä½“ï¼Œå¹¶ç”¨ DSL ä¸­çš„å€¼åˆå§‹åŒ–è¿™äº›ç»“æ„ä½“ã€‚

- å¦‚æœç¨ååœ¨ Makepad Studio ä¸­ä¿®æ”¹äº† DSL ä»£ç ï¼Œç›¸å…³çš„ Rust ç»“æ„ä½“ä¼šåœ¨è¿è¡Œæ—¶è‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åºã€‚

Live è®¾è®¡ç³»ç»Ÿä½¿ Makepad æ‹¥æœ‰å¼ºå¤§çš„ è¿è¡Œæ—¶æ ·å¼ç¼–è¾‘èƒ½åŠ›ã€‚ä½ å¯ä»¥åœ¨ Makepad Studio ä¸­åŠ¨æ€è°ƒæ•´ UI çš„å¸ƒå±€ã€é¢œè‰²ä»¥åŠå…¶ä»–æ ·å¼å±æ€§ï¼Œå¹¶ä¸”èƒ½åœ¨åº”ç”¨è¿è¡Œæ—¶ç«‹å³çœ‹åˆ°ä¿®æ”¹æ•ˆæœ â€”â€” æ— éœ€é‡æ–°ç¼–è¯‘ï¼

### `App` ç»“æ„ä½“

ä»¥ä¸‹ä»£ç å®šä¹‰äº† `App` ç»“æ„ä½“ï¼š

```rust
#[derive(Live, LiveHook)]
pub struct App {
    #[live]
    ui: WidgetRef,
}
```

App ç»“æ„ä½“æ˜¯æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒã€‚ç°åœ¨å®ƒä»…åŒ…å«æˆ‘ä»¬ç»„ä»¶æ ‘ï¼ˆwidget treeï¼‰çš„æ ¹èŠ‚ç‚¹ã€‚ç¨åæˆ‘ä»¬è¿˜ä¼šåœ¨å…¶ä¸­æ·»åŠ åº”ç”¨æ‰€éœ€çš„å„ç§çŠ¶æ€ã€‚

æ³¨æ„ï¼Œæˆ‘ä»¬ä¸º App ç»“æ„ä½“æ´¾ç”Ÿäº†ä¸¤ä¸ª traitï¼š`Live` å’Œ `LiveHook`ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ›´è¯¦ç»†åœ°äº†è§£è¿™ä¸¤ä¸ª traitã€‚

#### `Live` Trait

`Live` trait ä½¿ç»“æ„ä½“èƒ½å¤Ÿä¸ Live è®¾è®¡ç³»ç»Ÿè¿›è¡Œäº¤äº’ã€‚

è¦ä¸ºæŸä¸ªç»“æ„ä½“æ´¾ç”Ÿ `Live` traitï¼Œè¯¥ç»“æ„ä½“ä¸­çš„æ¯ä¸ªå­—æ®µéƒ½éœ€è¦æ ‡æ³¨ä»¥ä¸‹å±æ€§ä¹‹ä¸€ï¼š

- `#[live]` å±æ€§è¡¨ç¤ºè¯¥å­—æ®µå±äº Live è®¾è®¡ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚
- `#[rust]` å±æ€§è¡¨ç¤ºè¯¥å­—æ®µæ˜¯æ™®é€šçš„ Rust å­—æ®µã€‚

å½“ Live è®¾è®¡ç³»ç»Ÿé‡åˆ°æ ‡æœ‰ `#[live]` å±æ€§çš„å­—æ®µæ—¶ï¼Œå®ƒä¼šåœ¨ DSLï¼ˆé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰ä»£ç ä¸­æŸ¥æ‰¾è¯¥å­—æ®µçš„åŒ¹é…å®šä¹‰ã€‚å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±ä½¿ç”¨ DSL ä¸­çš„å®šä¹‰æ¥å®ä¾‹åŒ–è¯¥å­—æ®µï¼›å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä¼šä½¿ç”¨é»˜è®¤å€¼æ¥å®ä¾‹åŒ–è¯¥å­—æ®µã€‚

ç›¸å¯¹åœ°ï¼Œå½“ç³»ç»Ÿé‡åˆ°æ ‡æœ‰ `#[rust]` å±æ€§çš„å­—æ®µæ—¶ï¼Œå®ƒä¼šä½¿ç”¨è¯¥å­—æ®µç±»å‹çš„ `Default::default` æ„é€ å‡½æ•°æ¥å®ä¾‹åŒ–è¿™ä¸ªå­—æ®µã€‚

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ç”¨ `#[live]` å±æ€§æ ‡è®°äº† `App` ç»“æ„ä½“ä¸­çš„ `ui` å­—æ®µã€‚ç”±äºæˆ‘ä»¬åœ¨ DSL ä¸­ä¸ºè¯¥å­—æ®µæä¾›äº†ç›¸åº”çš„å®šä¹‰ï¼ŒLive è®¾è®¡ç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ® DSL ä¸­çš„å®šä¹‰å¡«å…… `ui` å­—æ®µï¼Œæ„å»ºå‡ºç»„ä»¶æ ‘ï¼šä¸€ä¸ªåŒ…å«ä¸€ä¸ªç©º `View` çš„ `Window`ï¼Œç”± `Root` ç»„ä»¶åŒ…è£¹ã€‚

#### `LiveHook` Trait

`LiveHook` trait æä¾›äº†ä¸€äº›å¯è¢«é‡å†™ï¼ˆoverridableï¼‰çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¼šåœ¨åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸçš„ä¸åŒé˜¶æ®µè¢«è°ƒç”¨ã€‚

ç›®å‰æˆ‘ä»¬æš‚æ—¶ç”¨ä¸åˆ°è¿™äº›æ–¹æ³•ï¼Œå› æ­¤å¯ä»¥ä¸º `App` ç»“æ„ä½“å®šä¹‰ä¸€ä¸ªç©ºçš„ `LiveHook` å®ç°ï¼š

```rust
impl LiveHook for App {}
```

æˆ–è€…ï¼Œä¹Ÿå¯ä»¥åƒæˆ‘ä»¬ç°åœ¨è¿™æ ·ä¸º `App` ç»“æ„ä½“æ´¾ç”Ÿï¼ˆderiveï¼‰`LiveHook trait`ã€‚è¿™æ ·ä¼šè‡ªåŠ¨ç”Ÿæˆä¸ä¸Šé¢ç›¸åŒçš„å®ç°ï¼Œä»è€Œçœå»äº†æ‰‹åŠ¨ç¼–å†™çš„å·¥ä½œã€‚

ç­‰åˆ°æˆ‘ä»¬çœŸæ­£éœ€è¦ç”¨åˆ°è¿™äº›æ–¹æ³•æ—¶ï¼Œå†æ¥è¯¦ç»†è§£é‡Š `LiveHook` trait çš„å…·ä½“ä½œç”¨ã€‚

### `AppMain` Trait

ä»¥ä¸‹ä»£ç ä¸º `App` ç»“æ„ä½“å®ç°äº† `AppMain` traitï¼š

```rust
impl AppMain for App {
    fn handle_event(&mut self, cx: &mut Cx, event: &Event) {
        self.ui.handle_event(cx, event, &mut Scope::empty());
    }
}
```

`AppMain` trait ç”¨äºå°† `App` ç»“æ„ä½“çš„ä¸€ä¸ªå®ä¾‹æŒ‚æ¥ï¼ˆhookï¼‰åˆ°ä¸»äº‹ä»¶å¾ªç¯ä¸­ã€‚åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•åœ°å°†æ‰€æœ‰äº‹ä»¶è½¬å‘ç»™ç»„ä»¶æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œç”±å®ƒæ¥è¿›è¡Œé€‚å½“çš„å¤„ç†ã€‚

åœ¨ Makepad ä¸­ï¼Œ**Scopeï¼ˆä½œç”¨åŸŸï¼‰** æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œç”¨äºåœ¨äº‹ä»¶ä¼ é€’è¿‡ç¨‹ä¸­æºå¸¦åº”ç”¨çº§åˆ«çš„æ•°æ®ä»¥åŠç»„ä»¶ç‰¹å®šçš„å±æ€§ã€‚

ç›®å‰æˆ‘ä»¬è¿˜æ²¡æœ‰ä»»ä½•çŠ¶æ€ï¼Œå› æ­¤æš‚æ—¶ä½¿ç”¨ `Scope::empty()` æ¥ä¸ºæ¯ä¸ªäº‹ä»¶åˆ›å»ºä¸€ä¸ªç©ºçš„ä½œç”¨åŸŸã€‚å…³äºä½œç”¨åŸŸçš„æ›´å¤šå†…å®¹ï¼Œæˆ‘ä»¬å°†åœ¨åé¢è¿›ä¸€æ­¥ä»‹ç»ã€‚

### `LiveRegister` Trait

ä»¥ä¸‹ä»£ç ä¸º `App` ç»“æ„ä½“å®ç°äº† `LiveRegister` traitï¼š

```rust
impl LiveRegister for App {
    fn live_register(cx: &mut Cx) {
        makepad_widgets::live_design(cx);
    }
}
```

`LiveRegister` trait ç”¨äºæ³¨å†Œ DSL ä»£ç ã€‚é€šè¿‡æ³¨å†Œ DSL ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥è®©æ•´ä¸ªåº”ç”¨è®¿é—®è¿™äº›å®šä¹‰ã€‚

å‰é¢æˆ‘ä»¬æåˆ°è¿‡ï¼Œlive design å—ç”¨äºå®šä¹‰ DSL ä»£ç ã€‚åœ¨åº•å±‚ï¼Œæ¯ä¸ª live design å—éƒ½ä¼šç”Ÿæˆä¸€ä¸ª `live_design` å‡½æ•°ï¼Œå½“è¿™ä¸ªå‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œä¼šå°†è¯¥å—ä¸­çš„ DSL ä»£ç æ³¨å†Œè¿›ç³»ç»Ÿã€‚è€Œæˆ‘ä»¬æ­£æ˜¯åœ¨ `LiveRegister` trait çš„å®ç°ä¸­è°ƒç”¨è¿™äº› `live_design` å‡½æ•°ã€‚

åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨äº† `makepad_widgets::live_design` å‡½æ•°ï¼Œç”¨äºæ³¨å†Œ **makepad_widgets** crate ä¸­çš„ DSL ä»£ç ã€‚å¦‚æœä¸è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°†æ— æ³•ä½¿ç”¨ä»»ä½•å†…ç½®ç»„ä»¶ï¼Œæ¯”å¦‚ä¹‹å‰çœ‹åˆ°çš„ `Root`ã€`Window` å’Œ `View` ç­‰ç»„ä»¶ã€‚

> **æ³¨æ„**ï¼šç”± `app.rs` æ–‡ä»¶é¡¶éƒ¨çš„ `live_design` å®ç”Ÿæˆçš„ `live_design` å‡½æ•°æ˜¯ä¸€ä¸ªç‰¹æ®Šå‡½æ•°ã€‚æˆ‘ä»¬ä¸éœ€è¦åœ¨è¿™é‡Œæ‰‹åŠ¨è°ƒç”¨å®ƒï¼Œå› ä¸ºå®ƒä¼šè¢« `app_main` å‡½æ•°è‡ªåŠ¨è°ƒç”¨ã€‚è€Œè¿™ä¸ª `app_main` å‡½æ•°æ˜¯ç”± `app_main` å®ç”Ÿæˆçš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä¼šè®²è§£å®ƒã€‚

### `app_main` å®

ä»¥ä¸‹ä»£ç è°ƒç”¨äº† `app_main` å®ã€‚

```rust
app_main!(App);
```
`app_main` å®ä¼šç”Ÿæˆä¸€ä¸ª `app_main` å‡½æ•°ï¼Œé‡Œé¢åŒ…å«å¯åŠ¨åº”ç”¨æ‰€éœ€çš„æ‰€æœ‰ä»£ç ã€‚

`app_main` å‡½æ•°çš„åŠŸèƒ½å¦‚ä¸‹ï¼š

- ä½¿ç”¨ `LiveRegister` trait æ³¨å†Œé¢å¤–çš„ DSL ä»£ç ã€‚
- æ³¨å†Œæ–‡ä»¶é¡¶éƒ¨çš„ DSL ä»£ç ã€‚
- ä½¿ç”¨ live design ç³»ç»Ÿå®ä¾‹åŒ– `App` ç»“æ„ä½“ã€‚
- ä½¿ç”¨ `AppMain` trait å°†è¯¥ `App` ç»“æ„ä½“å®ä¾‹æŒ‚æ¥åˆ°ä¸»äº‹ä»¶å¾ªç¯ä¸­ã€‚

## ä¸‹ä¸€æ­¥

æˆ‘ä»¬ç°åœ¨æœ‰äº†ä¸€ä¸ªæœ€ç®€çš„ Makepad åº”ç”¨ç¨‹åºï¼ŒåŒ…å«ä¸€ä¸ªç©ºçª—å£ã€‚æ¥ä¸‹æ¥çš„æ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬å°†å¼€å§‹ä¸ºåº”ç”¨æ„å»ºä¸€ä¸ªå›¾ç‰‡ç½‘æ ¼ã€‚
